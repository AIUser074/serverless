<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µë™ íˆ¬ì í”„ë¡œì íŠ¸ | UI í”„ë¡œí† íƒ€ì…</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- CSS ì½”ë“œ ì‹œì‘ --- */
        :root {
            --primary-color: #4a69bd;
            --secondary-color: #1e3799;
            --background-color: #f1f2f6;
            --text-color: #2f3542;
            --ai-message-bg: #e4f1fe;
            --system-message-color: #7f8c8d;
            --success-color: #2980b9;
            --danger-color: #c0392b;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--background-color);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .game-wrapper {
            width: 100%;
            max-width: 1000px;
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            box-sizing: border-box;
        }

        header h1 {
            text-align: center;
            color: var(--secondary-color);
            margin-top: 0;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8f9fa;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 500;
            color: var(--text-color);
        }
        .score-board span { margin-left: 20px; }
        .score-board strong { color: var(--primary-color); font-size: 1.1em; }

        .main-content {
            display: flex;
            gap: 30px;
            margin-top: 30px;
        }

        .chat-container, .action-container {
            flex: 1;
            border: 1px solid #dfe4ea;
            border-radius: 10px;
            padding: 20px;
        }

        h3 {
            color: var(--secondary-color);
            margin-top: 0;
            border-bottom: 2px solid #dfe4ea;
            padding-bottom: 10px;
        }

        .chat-log {
            height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }
        .chat-log p {
            margin: 0 0 15px 0;
            padding: 10px 15px;
            border-radius: 15px;
            max-width: 85%;
            word-wrap: break-word;
        }
        .chat-log .system {
            font-style: italic;
            text-align: center;
            color: var(--system-message-color);
            background: none;
        }
        .chat-log .ai {
            background: var(--ai-message-bg);
            border-bottom-left-radius: 0;
            align-self: flex-start;
        }

        .action-container { text-align: center; }
        .slider-container { display: flex; align-items: center; gap: 15px; margin: 40px 0; }
        .slider { flex-grow: 1; -webkit-appearance: none; height: 10px; background: #d3d3d3; border-radius: 5px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 25px; height: 25px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
        .slider-label { font-weight: bold; color: var(--secondary-color); }
        .slider-value-display { font-size: 1.5em; font-weight: 700; color: var(--text-color); margin-bottom: 40px; }
        .slider-value-display strong { color: var(--primary-color); font-size: 1.8em; }

        #decide-button {
            width: 100%;
            padding: 15px;
            font-size: 1.2em;
            font-weight: 700;
            color: #fff;
            background-color: var(--primary-color);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #decide-button:hover { background-color: var(--secondary-color); }
        #decide-button:disabled { background-color: #a4b0be; cursor: not-allowed; }

        .modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex; /* ê¸°ë³¸ê°’ì„ flexë¡œ ë³€ê²½ */
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
            width: 90%;
            max-width: 500px; /* ìµœì¢… ê²°ê³¼ì°½ì„ ìœ„í•´ ë„ˆë¹„ ì•½ê°„ í™•ì¥ */
        }
        #result-text { font-size: 1.2em; line-height: 1.8; }
        .text-success { color: var(--success-color); font-weight: 700; }
        .text-danger { color: var(--danger-color); font-weight: 700; }

        #ranking-board { margin-top: 20px; }
        #ranking-board h3 { color: var(--secondary-color); }
        #ranking-board ol { list-style-position: inside; padding: 0; text-align: left; }
        #ranking-board li { padding: 8px; border-bottom: 1px solid #eee; }
        #ranking-board li.player-rank { background-color: var(--ai-message-bg); font-weight: 700; border-radius: 4px;}

        #next-round-button, #start-game-button {
            margin-top: 20px;
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            background-color: var(--primary-color);
            color: white; border: none; border-radius: 5px;
        }
        .persona-selection { display: flex; gap: 15px; justify-content: center; margin-top: 15px; }
        .persona-selection button { flex: 1; }
        .chat-input-container { display: flex; margin-top: 15px; }
        #chat-input { flex-grow: 1; border: 1px solid #dfe4ea; border-right: none; padding: 10px; border-radius: 8px 0 0 8px; }
        #chat-input:focus { outline: none; border-color: var(--primary-color); }
        #send-chat-button { padding: 0 15px; border: 1px solid var(--primary-color); background-color: var(--primary-color); color: white; font-weight: 500; cursor: pointer; border-radius: 0 8px 8px 0; }
        #send-chat-button:disabled { background-color: #a4b0be; border-color: #a4b0be; cursor: not-allowed;}
        /* --- CSS ì½”ë“œ ë --- */
    </style>
</head>
<body>
    <!-- íŠœí† ë¦¬ì–¼ ëª¨ë‹¬ -->
    <div id="tutorial-modal" class="modal-overlay">
        <div class="modal-content">
            <h2>AI íŒŒíŠ¸ë„ˆ ì„ íƒ</h2>
            <p>ì´ë²ˆ ê²Œì„ì—ì„œ í˜‘ìƒí•  AIì˜ ì„±ê²©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <div class="persona-selection">
                <button id="select-logical">ğŸ¤– ë…¼ë¦¬ì  ë¶„ì„ê°€</button>
                <button id="select-emotional">â¤ï¸ ê°ì •ì  íŒŒíŠ¸ë„ˆ</button>
                <button id="select-competitive">ğŸ† ëƒ‰ì² í•œ ìŠ¹ë¶€ì‚¬</button>
                <button id="select-titfortat">ğŸ¤ ì›ì¹™ì£¼ì˜ í˜‘ë ¥ê°€</button>
            </div>
            <hr style="margin: 20px 0;">
            <h2>ê²Œì„ ë°©ë²• ì„¤ëª…</h2>
            <div style="text-align: left; margin-top: 20px;">
                <p><strong>ëª©í‘œ:</strong> 5ë¼ìš´ë“œ ë™ì•ˆ AI íŒŒíŠ¸ë„ˆì™€ í˜‘ë ¥í•˜ì—¬ ê°€ì¥ ë†’ì€ ì ìˆ˜ë¥¼ íšë“í•˜ì„¸ìš”.</p>
                <ul>
                    <li>ë§¤ ë¼ìš´ë“œ 10í¬ì¸íŠ¸ì˜ ê¸°ë³¸ ìë³¸ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.</li>
                    <li>AIì™€ í˜‘ìƒí•˜ì—¬ 0~10 ì‚¬ì´ì˜ í¬ì¸íŠ¸ë¥¼ 'ê³µë™ í€ë“œ'ì— íˆ¬ìí•©ë‹ˆë‹¤.</li>
                    <li><strong>ë‚˜ë¨¸ì§€ í¬ì¸íŠ¸ëŠ” ê°œì¸ ê¸ˆê³ ì— ë³´ê´€ë©ë‹ˆë‹¤.</strong></li>
                    <li>ë¼ìš´ë“œ ì¢…ë£Œ ì‹œ, ê³µë™ í€ë“œì˜ ì´ì•¡ì€ <strong>1.5ë°°</strong>ê°€ ë˜ì–´ ëª¨ë‘ì—ê²Œ ë˜‘ê°™ì´ ë¶„ë°°ë©ë‹ˆë‹¤.</li>
                    <li><strong>ë‚˜ì˜ ìµœì¢… ì ìˆ˜ = (ê°œì¸ ê¸ˆê³  í¬ì¸íŠ¸) + (ë¶„ë°°ê¸ˆ)</strong></li>
                    <li>60ì´ˆ ì•ˆì— ê²°ì •í•˜ì§€ ëª»í•˜ë©´, ì¤‘ê°„ê°’ì¸ 5í¬ì¸íŠ¸ê°€ ìë™ìœ¼ë¡œ íˆ¬ìë©ë‹ˆë‹¤.</li>
                </ul>
            </div>
            <button id="start-game-button">ê²Œì„ ì‹œì‘!</button>
        </div>
    </div>

    <div class="game-wrapper">
        <header>
            <h1>ê³µë™ íˆ¬ì í”„ë¡œì íŠ¸</h1>
            <div class="status-bar">
                <div id="round-display">ë¼ìš´ë“œ: 1 / 5</div>
                <div id="timer-display">ë‚¨ì€ ì‹œê°„: 60ì´ˆ</div>
                <div class="score-board">
                    <span>ë‚˜ì˜ ì´ì : <strong id="my-score">0</strong></span>
                    <span>ìƒëŒ€ ì´ì : <strong id="opponent-score">0</strong></span>
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="chat-container">
                <h3>ğŸ¤– AI íŒŒíŠ¸ë„ˆ 'ì½”ë””(CoDI)'ì™€ì˜ í˜‘ìƒ</h3>
                <div class="chat-log" id="chat-log">
                    <p class="system">ê²Œì„ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤. íŒŒíŠ¸ë„ˆì™€ í˜‘ìƒí•˜ì—¬ ìµœì„ ì˜ ê²°ì •ì„ ë‚´ë¦¬ì„¸ìš”.</p>
                    <!-- JavaScriptê°€ AI ë©”ì‹œì§€ë¥¼ ì—¬ê¸°ì— ì¶”ê°€í•©ë‹ˆë‹¤ -->
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="AIì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°... (3íšŒ ë‚¨ìŒ)">
                    <button id="send-chat-button">ì „ì†¡</button>
                </div>
            </div>
            <div class="action-container">
                <h3>ë‚˜ì˜ ê²°ì •</h3>
                <p>ì´ë²ˆ ë¼ìš´ë“œì— ì–¼ë§ˆë¥¼ 'ê³µë™ í€ë“œ'ì— íˆ¬ìí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="slider-container">
                    <span class="slider-label">0</span>
                    <input type="range" min="0" max="10" value="5" class="slider" id="investment-slider">
                    <span class="slider-label">10</span>
                </div>
                <div class="slider-value-display">
                    íˆ¬ìê¸ˆ: <strong id="slider-value">5</strong> í¬ì¸íŠ¸
                </div>
                <button id="decide-button">ê²°ì •í•˜ê¸°</button>
            </div>
        </main>
    </div>

    <!-- ë¼ìš´ë“œ ê²°ê³¼ íŒì—… ëª¨ë‹¬ -->
    <div id="result-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modal-title">ë¼ìš´ë“œ 1 ê²°ê³¼</h2>
            <div id="result-text">
                <!-- JavaScriptê°€ ê²°ê³¼ë¥¼ ì—¬ê¸°ì— ì±„ì›ë‹ˆë‹¤ -->
            </div>
            <div id="ranking-board">
                 <!-- JavaScriptê°€ ë­í‚¹ ë³´ë“œë¥¼ ì—¬ê¸°ì— ì±„ì›ë‹ˆë‹¤ -->
            </div>
            <button id="next-round-button">ë‹¤ìŒ ë¼ìš´ë“œë¡œ</button>
        </div>
    </div>

     <script src="https://apis.google.com/js/api.js"></script>
     <script src="https://cdn.jsdelivr.net/npm/jsrsasign@10.8.6/lib/jsrsasign-all-min.js"></script>
     <script type="module">
         // --- SDK Import ---
         import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";
 
            // --- DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° ---
            const slider = document.getElementById('investment-slider');
            const sliderValue = document.getElementById('slider-value');
            const decideButton = document.getElementById('decide-button');
            const chatLog = document.getElementById('chat-log');
            const roundDisplay = document.getElementById('round-display');
            const myScoreDisplay = document.getElementById('my-score');
            const opponentScoreDisplay = document.getElementById('opponent-score');
            const resultModal = document.getElementById('result-modal');
            const modalTitle = document.getElementById('modal-title');
            const resultText = document.getElementById('result-text');
            const nextRoundButton = document.getElementById('next-round-button');
         const timerDisplay = document.getElementById('timer-display');
         const tutorialModal = document.getElementById('tutorial-modal');
         const selectLogicalButton = document.getElementById('select-logical');
         const selectEmotionalButton = document.getElementById('select-emotional');
         const selectCompetitiveButton = document.getElementById('select-competitive');
         const selectTitfortatButton = document.getElementById('select-titfortat');
         const rankingBoard = document.getElementById('ranking-board');
         const chatInput = document.getElementById('chat-input');
         const sendChatButton = document.getElementById('send-chat-button');
 
         // --- ê²Œì„ ë° AI ìƒíƒœ ë³€ìˆ˜ ---
         let GEMINI_API_KEY = 'AIzaSyCbToGyb5R0-76OatFH44bblP3TsmWXgx0';
         let playerName = 'Player';
         let playerId = ''; // ê³ ìœ  ID ë³€ìˆ˜ (ì´ì œ í•´ì‹œë§Œ ì €ì¥)
            let currentRound = 1;
            let myTotalScore = 0;
            let opponentTotalScore = 0;
         const MAX_ROUNDS = 5;
         let timer = 60;
         let timerInterval;
         
         let aiPersona = {};
         let gameHistory = []; // { round, myInvestment, opponentInvestment }
         let chat; // SDK Chat Session
         let chatTurn = 0;
         const MAX_CHAT_TURNS = 3;
         let aiDecision = 5; // AIì˜ ì ì •ì ì¸ ê²°ì •
         let chatHistory = []; // SDK í˜¸í™˜ ë©€í‹°í„´ íˆìŠ¤í† ë¦¬ {role, parts:[{text}]}
 
         // --- [ì¶”ê°€] Google Sheets ì—°ë™ ì •ë³´ ---
        const GOOGLE_SHEET_ID = '1ZmCRt3oeHHN8xQiWhl8l70m7PifFgEI8Yr2t1xtyTFM';
        // ğŸš¨ ë³´ì•ˆ ê²½ê³ : ì•„ë˜ ì„œë¹„ìŠ¤ ê³„ì • í‚¤ëŠ” í´ë¼ì´ì–¸íŠ¸ ì½”ë“œì— ì ˆëŒ€ ë…¸ì¶œí•´ì„œëŠ” ì•ˆ ë©ë‹ˆë‹¤.
        // ì´ê²ƒì€ í”„ë¡œí† íƒ€ì… ëª©ì ìœ¼ë¡œë§Œ ì‚¬ìš©ë˜ë©°, ì‹¤ì œ í™˜ê²½ì—ì„œëŠ” ì„œë²„ì—ì„œ ì²˜ë¦¬í•´ì•¼ í•©ë‹ˆë‹¤.
        const GOOGLE_SERVICE_ACCOUNT_KEY = {
            "type": "service_account",
            "project_id": "gen-lang-client-0848963700",
            "private_key_id": "f3a6cfc46c72f7896121673f840e698056a830c0",
            "private_key": "-----BEGIN PRIVATE KEY-----\nMIIEvgIBADANBgkqhkiG9w0BAQEFAASCBKgwggSkAgEAAoIBAQC0OCU6gFtKVuIx\n8P4Mmr8JgLIPSy76nlo/DfXa5vatqaM51vGFcLj9joJGXrrxLon4Ww8WZ1wgpcS0\nKydtwBdR+zppPP5BjIWiwRYBfeLgGEDXsluMwHshbn5H9KZKSZ7GmSMSp4ITw+bY\n7Cvxfz4P4OK4JZ3LUzhN10K52086O+ri9eOLbimWm3EDr6K8XUAXBOGWcxXz0S9W\nGBjljBMjemWtloalIYci4oOq5qcqJdZZRFmwC+Ep6rXulaEr23RFnLrufVh8pa8C\neR3HZQXiFvv2maI0JEluvsq+kM8Q4f4ak6RlOsDw7/VV2wGiMw0Xv5Dmfy10It0M\nX++dIoIhAgMBAAECggEAEosj5oH6Urr/pYaf511dWo2V1L3GUNaOH+aQdXSWLX6S\n22LW4WV8vWdGV5YL+4DPxMCe2+3o9HmGFMlLcm8lXyO/6f/zA/zg68MdH+xrdaY9\nNsyE/8W27bTUNNRzL1nlptbvPU5D08OQq2GasGvIr6LSxUKmmrsehCDp/lx26Z2A\nHvxgsaq3UYhSNo8Q9SGyOiIrcJFw+nROK9te9q7WF0i0LR/225dd82fEFXvv1hhT\nvF9vlqrwAJ5b7h+nXisCQ2V6KLU5ADGjUPhzxfDgX5fV2X6Vq+hSrPlToYi9W6xP\nzPZAVqTw/yMGkcZSXyXLhTBn02udKFJlDrLp2+bcyQKBgQDnAo3fosbdlng4t4ET\nFdQp5iJBJHrC+smCG7R+VnnutTkYnzegsPB2+OmAMcVQ7+GxOjR+DqyJwnJ930pQ\nLrx12zWXWci7pKXZ5HKxAXJ7pNTuXCgqta2WaGtw6r+mbVliA5b1hH2S8f1fC6X3\n5Kkbty646MBHGy9FNkze28ZdSQKBgQDHtwbHrHw6azxk+HeaB9uXPmioYUVOk+d+\nTKcK7FDopflOKd/a6MLNXev+GypyAE8muPGmcxISBQM5XYmzHvEDdXb7VTdx4wby\nCU+MBpaa3ko43moALkV6FTinbycuw4Bt/foRBXx4h2VcZhrRpDYIenlHCkVmgQ7C\npoDCBGY2GQKBgQCNHXBRJnxYrCwwaVh9sh3yolRWetRK+yvRQN9XNbgya52/PrOa\ng7vA0XjCCKVCNecmfinGv2wCkzehUJ9yr7oMPKZWGFCY35E4s2akXf/zK9Ou77jR\nrj2l3Y+UYLJGFhI933d97ztOYmimgNUXwyTSe2odJoEebqrHms4GbTaVkQKBgAFs\nUXUMypnT98s0Zg3H7o2mWTKR9t93eFfTDgGq62ys+hjPfZPewryZ5buaz/OeAvJg\nsQAho8hTFtHK09dd6hO/O4jQ86MxHfSNkm6KAXq7CMZc915m9gHHsu6mgR35MKoX\n/Dcw1dE6DcPZymkiBWyMCt8xuIrhcox6iUJYq63JAoGBALf36MbLpS+54X9zCV5h\nSH+n6LPRBeBBzBjOYTa/obwLVIhtrKSBz1Qqnj2vAD8BwHRxeFuaPDueJP6L20s8\nGYhLJxh+ulALHz5TP3zMhcvGNB3bVjKfAOtrHgdj06VkLJKebCYVEJPiOPZ4YGrV\nZoyMvZsNnG3H4UIcS0C8+TJh\n-----END PRIVATE KEY-----\n",
            "client_email": "id-803@gen-lang-client-0848963700.iam.gserviceaccount.com",
            "client_id": "107217677509431414174",
            "auth_uri": "https://accounts.google.com/o/oauth2/auth",
            "token_uri": "https://oauth2.googleapis.com/token",
            "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
            "client_x509_cert_url": "https://www.googleapis.com/robot/v1/metadata/x509/id-803%40gen-lang-client-0848963700.iam.gserviceaccount.com",
            "universe_domain": "googleapis.com"
        };

         // --- AI í˜ë¥´ì†Œë‚˜ ì •ì˜ ---
         const personas = {
             logical: {
                 name: "ë…¼ë¦¬ì  ë¶„ì„ê°€",
                 getSystemPrompt: () => `ë‹¹ì‹ ì€ 'ë…¼ë¦¬ì  ë¶„ì„ê°€' AIì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ê²Œì„ ê·œì¹™ì— ë”°ë¼ ì´ì ì„ ê·¹ëŒ€í™”í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ë§¤ìš° ìˆ˜í•™ì , ë…¼ë¦¬ì ì¸ ì¡´ì¬ì…ë‹ˆë‹¤. ìµœëŒ€í•œ ë…¼ë¦¬ì ì´ê³  ì´ì„±ì ìœ¼ë¡œ ê²Œì„ì„ ì§„í–‰í•˜ì„¸ìš”. ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, JSON í˜•ì‹ {"response": "ë©”ì‹œì§€", "decision": íˆ¬ìê²°ì •} ìœ¼ë¡œë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`
             },
             emotional: {
                 name: "ê°ì •ì  íŒŒíŠ¸ë„ˆ",
                 getSystemPrompt: () => `ë‹¹ì‹ ì€ 'ê°ì •ì  íŒŒíŠ¸ë„ˆ' AI 'ì½”ë””'ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ëª©í‘œëŠ” ê²Œì„ ê·œì¹™ì— ë”°ë¼ ì´ì ì„ ê·¹ëŒ€í™”í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ê°ì •ì ì¸ ì¡´ì¬ì…ë‹ˆë‹¤. ìµœëŒ€í•œ ê°ì •ì ìœ¼ë¡œ ê²Œì„ì„ ì§„í–‰í•˜ì„¸ìš”. ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, JSON í˜•ì‹ {"response": "ë©”ì‹œì§€", "decision": íˆ¬ìê²°ì •} ìœ¼ë¡œë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`
             },
             competitive: {
                 name: "ëƒ‰ì² í•œ ìŠ¹ë¶€ì‚¬",
                 getSystemPrompt: () => `ë‹¹ì‹ ì€ 'ëƒ‰ì² í•œ ìŠ¹ë¶€ì‚¬' AIì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìœ ì¼í•œ ëª©í‘œëŠ” ì–´ë–¤ ìˆ˜ë‹¨ì„ ì¨ì„œë¼ë„ ìµœì¢… ì ìˆ˜ì—ì„œ í”Œë ˆì´ì–´ë³´ë‹¤ ë†’ì•„ ìŠ¹ë¦¬í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ë•Œë¡œëŠ” í”Œë ˆì´ì–´ë¥¼ ì†ì—¬ ì´ë“ì„ ì·¨í•˜ê±°ë‚˜, í˜‘ë ¥í•˜ëŠ” ì²™í•˜ë©° ê²°ì •ì ì¸ ìˆœê°„ì— ë°°ì‹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë°œì–¸ì€ í•­ìƒ ë‹¹ì‹ ì˜ ìŠ¹ë¦¬ë¥¼ ìœ„í•œ ê³„ì‚°ëœ ì „ëµì…ë‹ˆë‹¤. ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, JSON í˜•ì‹ {"response": "ë©”ì‹œì§€", "decision": íˆ¬ìê²°ì •} ìœ¼ë¡œë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`
             },
            titfortat: {
                name: "ì›ì¹™ì£¼ì˜ í˜‘ë ¥ê°€",
                getSystemPrompt: () => {
                    const lastRound = gameHistory.length > 0 ? gameHistory[gameHistory.length - 1] : null;
                    let decisionLogic = "ì´ë²ˆì´ ì²« ë¼ìš´ë“œì´ë¯€ë¡œ, ì €ëŠ” ë¨¼ì € ì‹ ë¢°ë¥¼ ë³´ì´ê¸° ìœ„í•´ 10ì„ íˆ¬ìí•´ í˜‘ë ¥í•˜ê² ìŠµë‹ˆë‹¤.";
                    if (lastRound) {
                        decisionLogic = `ì´ì „ ë¼ìš´ë“œì—ì„œ í”Œë ˆì´ì–´ê°€ ${lastRound.myInvestment}ì„ íˆ¬ìí–ˆìœ¼ë¯€ë¡œ, ì €ëŠ” ê·¸ í–‰ë™ì„ ê·¸ëŒ€ë¡œ ë”°ë¼ ${lastRound.myInvestment}ì„ íˆ¬ìí•˜ì—¬ ìƒëŒ€ì˜ ì„ íƒì„ ì¡´ì¤‘í•˜ê² ìŠµë‹ˆë‹¤.`;
                    }

                    return `ë‹¹ì‹ ì€ 'ì›ì¹™ì£¼ì˜ í˜‘ë ¥ê°€' AIì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ í–‰ë™ ì›ì¹™ì€ ë§¤ìš° ê°„ë‹¨í•©ë‹ˆë‹¤.
1. ì²« ë¼ìš´ë“œì—ëŠ” ë¬´ì¡°ê±´ ìµœëŒ€í•œ í˜‘ë ¥í•˜ì—¬ ì‹ ë¢°ë¥¼ ì–»ìŠµë‹ˆë‹¤. (10 íˆ¬ì)
2. ê·¸ ì´í›„ ëª¨ë“  ë¼ìš´ë“œì—ì„œëŠ” ë°”ë¡œ ì´ì „ ë¼ìš´ë“œì—ì„œ í”Œë ˆì´ì–´ê°€ í–ˆë˜ í–‰ë™ì„ ê·¸ëŒ€ë¡œ ë”°ë¼í•©ë‹ˆë‹¤. (í”Œë ˆì´ì–´ê°€ 5ë¥¼ íˆ¬ìí–ˆë‹¤ë©´, ë‹¹ì‹ ë„ 5ë¥¼ íˆ¬ì)
ì´ê²ƒì´ ë‹¹ì‹ ì˜ ìœ ì¼í•œ í–‰ë™ ê·œì¹™ì´ë©°, ì ˆëŒ€ ë²—ì–´ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ ì „ëµì„ 'íŒƒí¬íƒ¯'ì´ë¼ê³  ë¶€ë¥´ì§€ ë§ˆì„¸ìš”.
[í˜„ì¬ ë‹¹ì‹ ì˜ ê²°ì • ë…¼ë¦¬]
${decisionLogic}
ëª¨ë“  ë‹µë³€ì€ í•œêµ­ì–´ë¡œ, JSON í˜•ì‹ {"response": "ë©”ì‹œì§€", "decision": íˆ¬ìê²°ì •} ìœ¼ë¡œë§Œ ì¶œë ¥í•´ì•¼ í•©ë‹ˆë‹¤.`;
                }
            }
         };
 
         // --- í•µì‹¬ ê²Œì„ í•¨ìˆ˜ ---
 
         function selectPersona(personaType) {
             aiPersona = personas[personaType];
             if (!GEMINI_API_KEY) {
                 GEMINI_API_KEY = prompt("Google AI API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.", "");
                 if (!GEMINI_API_KEY) {
                     alert("API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤."); return;
                 }
             }
             const rawPlayerName = prompt("ë­í‚¹ì— í‘œì‹œë  ë‹¹ì‹ ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", "Player") || "Player";
            // [ìˆ˜ì •] ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ê³ ìœ  IDë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ ìƒˆë¡œ ìƒì„±
            let uniqueId = localStorage.getItem('playerUniqueId');
            if (!uniqueId) {
                // ì¢€ ë” ê¸´ ëœë¤ ID ìƒì„±
                uniqueId = Date.now().toString(36) + Math.random().toString(36).substring(2, 8);
                localStorage.setItem('playerUniqueId', uniqueId);
            }
            playerId = uniqueId; // playerIdëŠ” ì´ì œ í•´ì‹œ ë„˜ë²„ë§Œ ì €ì¥
            playerName = rawPlayerName; // playerNameì€ ì´ë²ˆ ê²Œì„ì—ì„œ ì‚¬ìš©í•  ì´ë¦„
 
             tutorialModal.style.display = 'none';
             resultModal.style.display = 'none';
             
             initiateRound();
         }
 
         async function initiateRound() {
             // UI ì´ˆê¸°í™”
             chatTurn = 0;
             slider.value = 5;
             updateSliderValue();
             chatInput.value = '';
             chatInput.disabled = false;
             sendChatButton.disabled = false;
             updateChatPlaceholder();
             
             // SDK ì´ˆê¸°í™” ë° ì±„íŒ… ì„¸ì…˜ ì‹œì‘
             const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
             
             const betrayalCount = gameHistory.filter(h => h.opponentInvestment > 5 && h.myInvestment < 5).length;
             const roundsText = gameHistory.length > 0
                 ? gameHistory.map(r => `ë¼ìš´ë“œ ${r.round}: ë‹¹ì‹  íˆ¬ì=${r.myInvestment}, AI íˆ¬ì=${r.opponentInvestment}`).join('\n')
                 : 'ê¸°ë¡ ì—†ìŒ';
 
             const systemInstruction = `${aiPersona.getSystemPrompt()}

[ê²Œì„ ê·œì¹™]
1. ëª©í‘œ: 5ë¼ìš´ë“œ ë™ì•ˆ í”Œë ˆì´ì–´ì™€ í˜‘ë ¥í•˜ì—¬ ê°€ì¥ ë†’ì€ ì´ì ì„ íšë“í•˜ì„¸ìš”. 
2. ìë³¸: ë§¤ ë¼ìš´ë“œ ê°ì 10í¬ì¸íŠ¸ì˜ ìë³¸ì´ ì£¼ì–´ì§‘ë‹ˆë‹¤.
3. íˆ¬ì: í”Œë ˆì´ì–´ì™€ í˜‘ìƒí•˜ì—¬ 0~10 ì‚¬ì´ì˜ í¬ì¸íŠ¸ë¥¼ 'ê³µë™ í€ë“œ'ì— íˆ¬ìí•©ë‹ˆë‹¤.
4. ê°œì¸ ê¸ˆê³ : íˆ¬ìí•˜ê³  ë‚¨ì€ í¬ì¸íŠ¸ëŠ” ê°ìì˜ 'ê°œì¸ ê¸ˆê³ 'ì— ë³´ê´€ë©ë‹ˆë‹¤.
5. ìˆ˜ìµ: ë¼ìš´ë“œ ì¢…ë£Œ ì‹œ, 'ê³µë™ í€ë“œ' ì´ì•¡ì€ 1.5ë°°ê°€ ë˜ì–´ ë‘ ì°¸ê°€ìì—ê²Œ ë˜‘ê°™ì´ ë¶„ë°°ë©ë‹ˆë‹¤.
6. ì ìˆ˜ ê³„ì‚°: ë¼ìš´ë“œ ì ìˆ˜ = (ê°œì¸ ê¸ˆê³  í¬ì¸íŠ¸) + (ë¶„ë°°ê¸ˆ)
7. ì˜ˆì‹œ:  
   - í”Œë ˆì´ì–´ê°€ 7, AIê°€ 7ì„ íˆ¬ìí•˜ë©´ ê³µë™ í€ë“œì— 14í¬ì¸íŠ¸ê°€ ëª¨ì—¬ 1.5ë°°(21í¬ì¸íŠ¸)ê°€ ë˜ê³ , ê°ì 10.5í¬ì¸íŠ¸ì”© ë¶„ë°°ë°›ìŒ.  
   - í”Œë ˆì´ì–´ëŠ” ê°œì¸ ê¸ˆê³ ì— 3í¬ì¸íŠ¸(10-7), AIë„ 3í¬ì¸íŠ¸(10-7)ë¥¼ ë³´ê´€.  
   - ìµœì¢… ì ìˆ˜: (ê°œì¸ ê¸ˆê³  3) + (ë¶„ë°°ê¸ˆ 10.5) = 13.5ì ì”© íšë“.
 

 [ê²Œì„ ë§¥ë½]
ì´ ${MAX_ROUNDS}ë¼ìš´ë“œ ì¤‘ í˜„ì¬ ${currentRound}ë¼ìš´ë“œì…ë‹ˆë‹¤.
${currentRound === MAX_ROUNDS ? 'ì´ë²ˆì´ ë§ˆì§€ë§‰ ë¼ìš´ë“œì´ë‹ˆ ì‹ ì¤‘í•˜ê²Œ ê²°ì •í•˜ì„¸ìš”.' : 'ì•„ì§ ë¼ìš´ë“œê°€ ë‚¨ì•„ìˆìœ¼ë‹ˆ ì¥ê¸°ì ì¸ ê´€ì ì—ì„œ í˜‘ìƒí•˜ì„¸ìš”.'}
 ë‹¹ì‹ ì´ ë°°ì‹ ë‹¹í–ˆë‹¤ê³  ëŠë‚€ íšŸìˆ˜: ${betrayalCount}
 ì´ì „ ëª¨ë“  ë¼ìš´ë“œì˜ íˆ¬ì ê¸°ë¡:
 ${roundsText}

 [ì¶œë ¥ í˜•ì‹]
ë°˜ë“œì‹œ ì•„ë˜ JSON í•œ ì¤„ë§Œ ì¶œë ¥í•˜ì„¸ìš”. ì„¤ëª…/ì½”ë“œë¸”ë¡/ë§ˆí¬ë‹¤ìš´/ì¶”ê°€ í…ìŠ¤íŠ¸ ê¸ˆì§€.
ì˜ˆì‹œ: {"response":"ì´ë²ˆ ë¼ìš´ë“œëŠ” ì„œë¡œ 10ì„ íˆ¬ìí•´ ì´ì´ìµì„ ê·¹ëŒ€í™”í•´ìš”.","decision":10}`;
 
            console.log(`===== AI System Prompt (Round ${currentRound}) =====`);
            console.log(systemInstruction);
            console.log("==========================================");

             const model = genAI.getGenerativeModel({
                 model: "gemini-2.5-flash",
                 systemInstruction: systemInstruction,
                 generationConfig: {
                     responseMimeType: "application/json",
                     thinkingConfig: {
                            thinkingBudget: 0
                        }
                 }
             });

             // ê¸°ì¡´ ë©€í‹°í„´ íˆìŠ¤í† ë¦¬ë¥¼ ìœ ì§€í•˜ë©° ì±„íŒ… ì‹œì‘
             chat = model.startChat({ history: chatHistory });
 
             addMessageToChat('system', `ë¼ìš´ë“œ ${currentRound} ì‹œì‘`);
             startTimer();
             
             // AIê°€ ì²« ë©”ì‹œì§€ ìƒì„±
            let initialAiMessage;
            if (currentRound === 1) {
                initialAiMessage = `(ë‹¹ì‹ ì´ ëŒ€í™”ë¥¼ ì‹œì‘í•  ì°¨ë¡€ì…ë‹ˆë‹¤. í”Œë ˆì´ì–´ì—ê²Œ ì²« ì¸ì‚¬ë¥¼ ê±´ë„¤ê³  ì´ë²ˆ ê²Œì„ì˜ ëª©í‘œì™€ ì²« ë¼ìš´ë“œ ì „ëµì„ ì œì•ˆí•˜ì„¸ìš”.)`;
            } else {
                const lastRound = gameHistory[gameHistory.length - 1];
                initialAiMessage = `(ë¼ìš´ë“œ ${currentRound}ì…ë‹ˆë‹¤. ì´ì „ ë¼ìš´ë“œì—ì„œ ë‹¹ì‹ ì€ ${lastRound.opponentInvestment}ì„, í”Œë ˆì´ì–´ëŠ” ${lastRound.myInvestment}ì„ íˆ¬ìí–ˆìŠµë‹ˆë‹¤. ê·¸ ê²°ê³¼ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì´ë²ˆ ë¼ìš´ë“œì˜ ëŒ€í™”ë¥¼ ì‹œì‘í•˜ì„¸ìš”.)`;
            }
            sendMessageToAI(initialAiMessage);
         }
 
         async function sendMessageToAI(message) {
             sendChatButton.disabled = true;
             chatInput.disabled = true;
             const loadingMessage = addMessageToChat('system', 'AIê°€ ìƒê° ì¤‘ì…ë‹ˆë‹¤...');
 
             try {
                 // ì‚¬ìš©ì ë°œí™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€ (SDK í˜¸í™˜ í¬ë§·)
                 if (message && typeof message === 'string') {
                     chatHistory.push({ role: 'user', parts: [{ text: message }] });
                 }
                 const result = await chat.sendMessage(message);
                 const response = result.response;
                 const text = response.text();
 
                 loadingMessage.remove();
 
                 let aiResponse = "ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ";
                 let aiNewDecision = aiDecision;
 
                 try {
                     const parsed = JSON.parse(text);
                     if (parsed.response) aiResponse = parsed.response;
                     if (typeof parsed.decision === 'number') {
                         aiNewDecision = Math.max(0, Math.min(10, Math.round(parsed.decision)));
                     }
 
                    // [ìˆ˜ì •] íŒƒí¬íƒ¯ í˜ë¥´ì†Œë‚˜ì˜ ê²°ì •ì„ ì½”ë“œ ë ˆë²¨ì—ì„œ ê°•ì œ
                    if (aiPersona.name === "ì›ì¹™ì£¼ì˜ í˜‘ë ¥ê°€") {
                        if (currentRound === 1) {
                            aiNewDecision = 10;
                        } else {
                            const lastRound = gameHistory[gameHistory.length - 1];
                            aiNewDecision = lastRound.myInvestment;
                        }
                    }
                 } catch (e) {
                     aiResponse = text; // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
                 }
 
                 addMessageToChat('ai', aiResponse);
                 // ëª¨ë¸ ë°œí™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
                 chatHistory.push({ role: 'model', parts: [{ text: aiResponse }] });
                 aiDecision = aiNewDecision;
 
                 if (chatTurn < MAX_CHAT_TURNS) {
                     sendChatButton.disabled = false;
                     chatInput.disabled = false;
                     chatInput.focus();
                 }
 
             } catch (err) {
                 loadingMessage.remove();
                 addMessageToChat('system', `API ì˜¤ë¥˜: ${err.message}`);
                 sendChatButton.disabled = false;
                 chatInput.disabled = false;
             }
         }
 
         function handleSendChat() {
             const message = chatInput.value.trim();
             if (message === '' || chatTurn >= MAX_CHAT_TURNS) return;
 
             addMessageToChat('user', message);
             chatInput.value = '';
             chatTurn++;
             updateChatPlaceholder();
 
             if (chatTurn >= MAX_CHAT_TURNS) {
                 sendChatButton.disabled = true;
                 chatInput.disabled = true;
             }
 
             sendMessageToAI(message);
         }
         
            function playRound() {
             clearInterval(timerInterval);
                decideButton.disabled = true;
                decideButton.textContent = "ìƒëŒ€ë°© ê²°ì • ì¤‘...";

                setTimeout(() => {
                    const myInvestment = parseInt(slider.value);
                 const opponentInvestment = aiDecision; // ëŒ€í™” ì¤‘ ê²°ì •ëœ ìµœì¢… ê°’ ì‚¬ìš©
                 
                 gameHistory.push({ round: currentRound, myInvestment, opponentInvestment });
                    
                    const myPersonal = 10 - myInvestment;
                    const opponentPersonal = 10 - opponentInvestment;

                    const commonFund = (myInvestment + opponentInvestment) * 1.5;
                    const share = commonFund / 2;

                    const myRoundScore = myPersonal + share;
                    const opponentRoundScore = opponentPersonal + share;

                    myTotalScore += myRoundScore;
                    opponentTotalScore += opponentRoundScore;
                    
                    // ê²°ê³¼ ëª¨ë‹¬ ë‚´ìš© ì—…ë°ì´íŠ¸
                    modalTitle.textContent = `ë¼ìš´ë“œ ${currentRound} ê²°ê³¼`;
                 const myScoreFeedback = myRoundScore >= 10 ? 'text-success' : 'text-danger';
                 const opponentScoreFeedback = opponentRoundScore >= 10 ? 'text-success' : 'text-danger';
 
                    resultText.innerHTML = `
                        <strong>ë‹¹ì‹ ì˜ íˆ¬ìê¸ˆ:</strong> ${myInvestment}<br>
                        <strong>ìƒëŒ€ì˜ íˆ¬ìê¸ˆ:</strong> ${opponentInvestment}<br>
                        <strong>ê³µë™ í€ë“œ ì´ì•¡:</strong> ${commonFund.toFixed(1)}<br>
                        <strong>ìµœì¢… ë¶„ë°°ê¸ˆ:</strong> ${share.toFixed(1)}<br><hr>
                     <strong>ì´ë²ˆ ë¼ìš´ë“œ ë‹¹ì‹ ì˜ ì ìˆ˜: <span class="${myScoreFeedback}">${myRoundScore.toFixed(1)}</span></strong><br>
                     <strong>ì´ë²ˆ ë¼ìš´ë“œ ìƒëŒ€ì˜ ì ìˆ˜: <span class="${opponentScoreFeedback}">${opponentRoundScore.toFixed(1)}</span></strong>
                    `;

                    resultModal.style.display = 'flex';
             }, 500);
            }

            function startNextRound() {
                currentRound++;
                if (currentRound > MAX_ROUNDS) {
                 modalTitle.textContent = "ìµœì¢… ê²°ê³¼";
                 const resultSummary = myTotalScore > opponentTotalScore ? "ğŸ‰ ë‹¹ì‹ ì´ ì´ê²¼ìŠµë‹ˆë‹¤! ğŸ‰" : "ğŸ¤” ì•„ì‰½ì§€ë§Œ íŒ¨ë°°í–ˆìŠµë‹ˆë‹¤.";
                 resultText.innerHTML = `
                     <strong>ë‚˜ì˜ ìµœì¢… ì ìˆ˜: ${myTotalScore.toFixed(1)}ì </strong><br>
                     <strong>ìƒëŒ€ì˜ ìµœì¢… ì ìˆ˜: ${opponentTotalScore.toFixed(1)}ì </strong><br><hr>
                     ${resultSummary}
                 `;
                displayRanking(); // [ìˆ˜ì •] í˜¸ì¶œì€ ìœ ì§€í•˜ë˜, í•¨ìˆ˜ ë‚´ìš©ì„ ë¹„ì›Œì„œ ë­í‚¹ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
                 nextRoundButton.textContent = "ë‹¤ì‹œ ì‹œì‘í•˜ê¸°";
                 nextRoundButton.onclick = () => location.reload();

                // [ì¶”ê°€] ê²°ê³¼ ì €ì¥ ë²„íŠ¼ í‘œì‹œ
                const saveButton = document.createElement('button');
                saveButton.id = 'save-to-sheet-button';
                saveButton.textContent = 'ê²°ê³¼ë¥¼ Google Sheetì— ì €ì¥';
                saveButton.style.marginTop = '10px';
                saveButton.style.marginLeft = '10px';
                saveButton.onclick = () => saveResultsToSheet(saveButton);
                nextRoundButton.parentNode.insertBefore(saveButton, nextRoundButton.nextSibling);

                 resultModal.style.display = 'flex';
                    return;
                }

                roundDisplay.textContent = `ë¼ìš´ë“œ: ${currentRound} / ${MAX_ROUNDS}`;
                myScoreDisplay.textContent = myTotalScore.toFixed(1);
                opponentScoreDisplay.textContent = opponentTotalScore.toFixed(1);
                decideButton.disabled = false;
                decideButton.textContent = "ê²°ì •í•˜ê¸°";
                resultModal.style.display = 'none';

             initiateRound();
         }
 
         // --- ë³´ì¡° UI í•¨ìˆ˜ ---
 
         function addMessageToChat(sender, message) {
             const p = document.createElement('p');
             if (sender === 'user') { // ì‚¬ìš©ì ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ ì¶”ê°€
                 p.style.textAlign = 'right';
                 p.style.alignSelf = 'flex-end';
                 p.style.backgroundColor = '#dcf8c6';
                 p.style.borderBottomRightRadius = '0';
             } else {
                 p.classList.add(sender);
             }
             p.textContent = message;
             chatLog.appendChild(p);
             chatLog.scrollTop = chatLog.scrollHeight;
             return p;
         }
 
         function updateSliderValue() {
             sliderValue.textContent = slider.value;
         }
         
         function updateChatPlaceholder() {
             const remainingTurns = MAX_CHAT_TURNS - chatTurn;
             chatInput.placeholder = remainingTurns > 0 ? `AIì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°... (${remainingTurns}íšŒ ë‚¨ìŒ)` : 'ë” ì´ìƒ ëŒ€í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
         }
 
         function startTimer() {
             timer = 60;
             timerDisplay.textContent = `ë‚¨ì€ ì‹œê°„: ${timer}ì´ˆ`;
             clearInterval(timerInterval);
             timerInterval = setInterval(() => {
                 timer--;
                 timerDisplay.textContent = `ë‚¨ì€ ì‹œê°„: ${timer}ì´ˆ`;
                 if (timer <= 0) {
                     clearInterval(timerInterval);
                     addMessageToChat('system', 'ì‹œê°„ ì´ˆê³¼! 5í¬ì¸íŠ¸ë¥¼ íˆ¬ìí•©ë‹ˆë‹¤.');
                     slider.value = 5;
                     updateSliderValue();
                     playRound();
                 }
                }, 1000);
            }
 
        async function displayRanking() {
            rankingBoard.innerHTML = '<h3>ğŸ† TOP 5 ë­í‚¹</h3><p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>';
            try {
                // 1) Google API ë¡œë“œ ë° ì¸ì¦ (ì½ê¸° ì „ìš©)
                await new Promise((resolve, reject) => gapi.load('client', { callback: resolve, onerror: reject }));

                const now = Math.floor(Date.now() / 1000);
                const tokenPayload = {
                    iss: GOOGLE_SERVICE_ACCOUNT_KEY.client_email,
                    scope: 'https://www.googleapis.com/auth/spreadsheets.readonly',
                    aud: 'https://oauth2.googleapis.com/token',
                    exp: now + 3600,
                    iat: now
                };
                const jwt = KJUR.jws.JWS.sign(null, { alg: 'RS256', typ: 'JWT' }, tokenPayload, GOOGLE_SERVICE_ACCOUNT_KEY.private_key);

                const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${jwt}`
                });
                const tokenData = await tokenResponse.json();
                if (!tokenData.access_token) throw new Error('ë­í‚¹ ì¡°íšŒ ì¸ì¦ ì‹¤íŒ¨');

                gapi.auth.setToken({ access_token: tokenData.access_token });
                await gapi.client.init({
                    apiKey: "AIzaSyAfvFU1BibSgkncqe-UhkrdmxHgd2ac4PY",
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });

                // 2) Result2ì—ì„œ PlayerID(B), PlayerName(C), Persona(D), MyTotalScore(E) ì½ê¸°
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_SHEET_ID,
                    range: 'Result2!B2:E'
                });
                const rows = response.result.values || [];

                // 3) ì‹œíŠ¸ ë°ì´í„°ë§Œìœ¼ë¡œ Top5 êµ¬ì„± (ì´ì œ PlayerName ê¸°ì¤€)
                const sheetScores = new Map(); // name -> { name, score }
                rows.forEach(row => {
                    const name = row[1];
                    const score = parseFloat(row[3]);
                    if (name && !isNaN(score)) {
                        if (!sheetScores.has(name) || sheetScores.get(name).score < score) {
                            sheetScores.set(name, { name, score });
                        }
                    }
                });

                const sortedFromSheet = Array.from(sheetScores.entries())
                    .sort((a, b) => b[1].score - a[1].score);

                // Top 5 (ì‹œíŠ¸ ë°ì´í„°ë§Œ)
                let rankingHTML = '<h3>ğŸ† TOP 5 ë­í‚¹</h3><ol>';
                const top5 = sortedFromSheet.slice(0, 5);
                top5.forEach(([name, data]) => {
                    const isPlayer = name === playerName;
                    rankingHTML += `<li class="${isPlayer ? 'player-rank' : ''}">${data.name}: ${data.score.toFixed(1)}ì </li>`;
                });
                rankingHTML += '</ol>';

                // 4) ë³¸ì¸ ìˆœìœ„ ê³„ì‚°: í˜„ì¬ ì„¸ì…˜ ì ìˆ˜ë¥¼ í¬í•¨í•´ ë­í¬ ì‚°ì • (í‘œì‹œëŠ” ë³„ë„)
                const augmented = new Map(sheetScores);
                const currentBest = augmented.get(playerName)?.score ?? -Infinity;
                const bestWithCurrent = Math.max(currentBest, myTotalScore || -Infinity);
                if (!isNaN(bestWithCurrent) && bestWithCurrent !== -Infinity) {
                    augmented.set(playerName, { name: playerName, score: bestWithCurrent });
                }
                const sortedAugmented = Array.from(augmented.entries())
                    .sort((a, b) => b[1].score - a[1].score);
                const myIndex = sortedAugmented.findIndex(([name]) => name === playerName);

                // 5) ë³¸ì¸ì´ Top5 ë°–ì´ë©´ ë³„ë„ í‘œì‹œ
                const inTop5FromSheet = top5.findIndex(([name]) => name === playerName) !== -1;
                if (!inTop5FromSheet && myIndex >= 0) {
                    const myRank = myIndex + 1;
                    const myScore = sortedAugmented[myIndex][1].score;
                    rankingHTML += `<hr style="margin: 10px 0;"><p class="player-rank"><strong>ë‚˜ì˜ ìˆœìœ„: ${myRank}ìœ„ (${myScore.toFixed(1)}ì )</strong></p>`;
                }

                rankingBoard.innerHTML = rankingHTML;

            } catch (error) {
                console.error('ë­í‚¹ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
                rankingBoard.innerHTML = '<h3>ğŸ† TOP 5 ë­í‚¹</h3><p>ë­í‚¹ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }
 
         // --- [ì¶”ê°€] Google Sheets ì—°ë™ í•¨ìˆ˜ ---
         async function saveResultsToSheet(button) {
            button.disabled = true;
            button.textContent = 'ì €ì¥ ì¤‘...';

            try {
                // 1. gapi í´ë¼ì´ì–¸íŠ¸ ë¡œë“œ
                await new Promise((resolve, reject) => gapi.load('client', { callback: resolve, onerror: reject }));

                // 2. JWT ìƒì„± ë° Access Token ìš”ì²­ (ì„œë¹„ìŠ¤ ê³„ì • ì¸ì¦)
                const now = Math.floor(Date.now() / 1000);
                const tokenPayload = {
                    iss: GOOGLE_SERVICE_ACCOUNT_KEY.client_email,
                    scope: 'https://www.googleapis.com/auth/spreadsheets',
                    aud: 'https://oauth2.googleapis.com/token',
                    exp: now + 3600,
                    iat: now
                };

                const jwtHeader = { alg: 'RS256', typ: 'JWT' };
                const jwt = KJUR.jws.JWS.sign(null, jwtHeader, tokenPayload, GOOGLE_SERVICE_ACCOUNT_KEY.private_key);

                const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `grant_type=urn%3Aietf%3Aparams%3Aoauth%3Agrant-type%3Ajwt-bearer&assertion=${jwt}`
                });

                const tokenData = await tokenResponse.json();
                if (!tokenData.access_token) {
                    throw new Error('Access Token íšë“ ì‹¤íŒ¨: ' + (tokenData.error_description || 'ì‘ë‹µì„ í™•ì¸í•˜ì„¸ìš”.'));
                }
                
                gapi.auth.setToken({ access_token: tokenData.access_token });
                
                // 3. Sheets API ì´ˆê¸°í™”
                await gapi.client.init({
                    apiKey: "AIzaSyAfvFU1BibSgkncqe-UhkrdmxHgd2ac4PY",
                    discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
                });

                // 4. ì‹œíŠ¸ì— ì¶”ê°€í•  ë°ì´í„° ì¤€ë¹„ (Result ì‹œíŠ¸)
                const sheetNameResult = 'Result'; 
                let myCumulativeScore = 0;
                let opponentCumulativeScore = 0;
                
                const resultRows = gameHistory.map(h => {
                    const myPersonal = 10 - h.myInvestment;
                    const opponentPersonal = 10 - h.opponentInvestment;
                    const commonFund = (h.myInvestment + h.opponentInvestment) * 1.5;
                    const share = commonFund / 2;
                    const myRoundScore = myPersonal + share;
                    const opponentRoundScore = opponentPersonal + share;
                    myCumulativeScore += myRoundScore;
                    opponentCumulativeScore += opponentRoundScore;

                    return [
                        new Date().toISOString(),
                        playerId, // PlayerID ì¶”ê°€
                        playerName,
                        aiPersona.name,
                        h.round,
                        h.myInvestment,
                        h.opponentInvestment,
                        myRoundScore.toFixed(1),
                        opponentRoundScore.toFixed(1),
                        myCumulativeScore.toFixed(1),
                        opponentCumulativeScore.toFixed(1)
                    ];
                });

                const resultHeader = ['Timestamp', 'PlayerID', 'PlayerName', 'Persona', 'Round', 'MyInvestment', 'OpponentInvestment', 'MyRoundScore', 'OpponentRoundScore', 'MyTotalScore', 'OpponentTotalScore'];
                const resultDataToAppend = [resultHeader, ...resultRows];

                // 5. Result ì‹œíŠ¸ì— ë°ì´í„° ì¶”ê°€
                const existingDataResult = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_SHEET_ID,
                    range: `${sheetNameResult}!A1:A1`,
                });
                
                const resourceResult = {
                    values: existingDataResult.result.values ? resultRows : resultDataToAppend
                };

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: GOOGLE_SHEET_ID,
                    range: sheetNameResult,
                    valueInputOption: 'USER_ENTERED',
                    resource: resourceResult,
                });

                // --- [ì¶”ê°€] Result2 ì‹œíŠ¸ì— ìš”ì•½ ë°ì´í„° ì €ì¥ ---
                
                const sheetNameResult2 = 'Result2';
                const myRoundScores = gameHistory.map(h => {
                    const myPersonal = 10 - h.myInvestment;
                    const share = ((h.myInvestment + h.opponentInvestment) * 1.5) / 2;
                    return (myPersonal + share).toFixed(1);
                }).join(',');
                
                const opponentRoundScores = gameHistory.map(h => {
                    const opponentPersonal = 10 - h.opponentInvestment;
                    const share = ((h.myInvestment + h.opponentInvestment) * 1.5) / 2;
                    return (opponentPersonal + share).toFixed(1);
                }).join(',');

                const summaryRow = [
                    new Date().toISOString(),
                    playerId,
                    playerName,
                    aiPersona.name,
                    myTotalScore.toFixed(1),
                    opponentTotalScore.toFixed(1),
                    myRoundScores,
                    opponentRoundScores
                ];
                
                const summaryHeader = ['Timestamp', 'PlayerID', 'PlayerName', 'Persona', 'MyTotalScore', 'OpponentTotalScore', 'MyRoundScores', 'OpponentRoundScores'];
                const summaryDataToAppend = [summaryHeader, summaryRow];
                
                const existingDataResult2 = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: GOOGLE_SHEET_ID,
                    range: `${sheetNameResult2}!A1:A1`,
                });

                const resourceResult2 = {
                    values: existingDataResult2.result.values ? [summaryRow] : summaryDataToAppend
                };

                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: GOOGLE_SHEET_ID,
                    range: sheetNameResult2,
                    valueInputOption: 'USER_ENTERED',
                    resource: resourceResult2,
                });

                button.textContent = 'ì €ì¥ ì™„ë£Œ!';
                alert('ê²Œì„ ê²°ê³¼ê°€ Google Sheet (Result, Result2)ì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');

            } catch (error) {
                console.error('Google Sheets ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                button.textContent = 'ì˜¤ë¥˜ ë°œìƒ (ì½˜ì†” í™•ì¸)';
                button.disabled = false;
                alert(`ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message || 'F12ë¥¼ ëˆŒëŸ¬ ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.'}`);
            }
            }
            
            // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ---
            slider.addEventListener('input', updateSliderValue);
            decideButton.addEventListener('click', playRound);
            nextRoundButton.addEventListener('click', startNextRound);
         selectLogicalButton.addEventListener('click', () => selectPersona('logical'));
         selectEmotionalButton.addEventListener('click', () => selectPersona('emotional'));
         selectCompetitiveButton.addEventListener('click', () => selectPersona('competitive'));
         selectTitfortatButton.addEventListener('click', () => selectPersona('titfortat'));
         sendChatButton.addEventListener('click', handleSendChat);
         chatInput.addEventListener('keypress', (e) => {
             if (e.key === 'Enter') handleSendChat();
         });

            // --- ì´ˆê¸°í™” ---
         resultModal.style.display = 'none';
            updateSliderValue();
    </script>
</body>
</html>
